<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title> Dave </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body>
    <div>
        <form class="firebase-form">
            <label><span>name</span></label>
            <input type="text" name="username" value="testName" />
            <input type="submit">
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyAHmbjjMt8WdwINBF3lY63DroVJgQ3GBcg",
            authDomain: "data-vaults-on-web.firebaseapp.com",
            databaseURL: "https://data-vaults-on-web.firebaseio.com",
            projectId: "data-vaults-on-web",
            storageBucket: "data-vaults-on-web.appspot.com",
            messagingSenderId: "455933671072"
        };

        function str2ab(str) {
            const buf = new ArrayBuffer(str.length);
            const bufView = new Uint8Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        function ab2str(buf) {
            return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        const KEY_NAME = "private key";
        const pemEncodedRSAKey = "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEApfDC/07geX3T4/QAD4YTSEJHNRLhMnF6KmA46FSn9FV7Q8cRZBytd81S+S6dYoCiia4e7kmNL4gdKGWTiNb8oc264PPuTxKe7yG+KCcFyzQWuDBBSNeLRZYbBzdVkN/JYAcGU0vpQuztwkBfWrjidqEMfNtX8Vrssw35/h9ZyqxdJ+FrnqDdxnjvfjd85C5VHlV5uPf+fdb22IV1mgUTP1n0tTDuFHDpHZXcsDt7dwoIsb4z/fna4njJ353z+siM42LaiOSVwohqwRtLj7ZV75UDilU2IP3Dhju2LgfUP5SM7+Z+opu+DIPXSoQh6C85skjMRWtFBBlK25wyrDbyz2k1UfRIWWVZtlBWy7m6UtfXrvS6r4Ai0UFW7rnmG16sty5djr3lCIBagfLDGfX6yTGIW7iwvJmWKayaL2GrHguO3VUwlRFgEFgYMgHtIkvgibsfx4mTudv3Hmlo3NvahJioppItT/5bQt/Si226PD2ce1v0ndbZ87sqquh95pIokReZAg0MXvaqH+o/e6rK4Lu1cQMePqCcbhcOBWGEgAxjj84iZE6MGuJY+oqWp4rdvwUA2Xlp7VjfWoyDssqtRn27jXakTsppxGWWgrWRrVBt7+IXFu5KcxRKMTUglU6WA4Efc8Sd4r4C3fH3DwqhzidmKIAT7kVq6eN/mldxbikCAwEAAQ==";

        function importRsaKey(pem) {

            const binaryDerString = window.atob(pem);

            const binaryDer = str2ab(binaryDerString);

            return window.crypto.subtle.importKey(
                "spki",
                binaryDer,
                {
                    name: "RSA-OAEP",
                    hash: "SHA-256"
                },
                true,
                ["encrypt"]
            );
        }


        function exportCryptoAESKey(key) {
            return new Promise(function (resolve, reject) {
                window.crypto.subtle.exportKey("raw", key).then(function (response) {
                    resolve(response);
                }, function (error) {
                    reject(error);
                });
            });
        };

        function generateAESKey() {
            return new Promise(function (resolve, reject) {
                window.crypto.subtle.generateKey({ // the generated AES KEY
                    name: "AES-CBC",
                    length: 256,
                },
                    true,
                    ["encrypt", "decrypt"]
                ).then(function (response) {
                    resolve(response);
                }, function (error) {
                    reject(error);
                });
            });
        }

        // generateAESKey().then(function (response) {
        //     console.log("PROMISES TEST");
        //     console.log(response);
        // }, function (error) {
        //     console.log(error);
        // })

        function encryptMessage(key, iv, message) {
            let encoder = new TextEncoder();

            let encoded = encoder.encode(message);
            // iv will be needed for decryption
            return window.crypto.subtle.encrypt({ name: "AES-CBC", iv }, key, encoded);
        }

        function encryptMessageUsingRSA(publicKey, message) {
            let enc = new TextEncoder();
            return window.crypto.subtle.encrypt(
                {
                    name: "RSA-OAEP"
                },
                publicKey,
                enc.encode(message)
            );
        }



        firebase.initializeApp(config);

        let forms = document.getElementsByClassName("firebase-form");

        [...forms].forEach(form => {
            let obj = {};
            [...form.elements].forEach((input) => {
                if (input.type !== "submit") {

                    console.log(input);
                    obj[input.name] = input.value
                }
            });
            //TODO: DO THE LOGIC FOR ENCRYPT ETC

            console.log(obj);

            let cryptoWork = generateAESKey().then(function (generatedAESKey) {

                console.log(generatedAESKey);
                let initializationVector = window.crypto.getRandomValues(new Uint8Array(16));

                return window.crypto.subtle.encrypt({ name: "AES-CBC", iv: initializationVector, }, generatedAESKey, str2ab(JSON.stringify(obj)))
                    .then(function (encrypted) {
                        //returns an ArrayBuffer containing the encrypted data
                        let encryptedContent = ab2str(encrypted);
                        console.log(encryptedContent);

                        resultedObject = {
                            iv: initializationVector,
                            ciphertext: encryptedContent,
                            cipherkey: generatedAESKey
                        };

                        console.log(resultedObject);
                        return resultedObject;
                    }).catch(function (err) {
                        console.error(err);
                    });
            })



            let finalObjectToSubmit = cryptoWork.then(function (cryptoWorkResults) {

                return exportCryptoAESKey(cryptoWorkResults.cipherkey).then(function (aesKeyArrayBuffer) {
                    let rawAESKey = ab2str(aesKeyArrayBuffer);
                    return importRsaKey(pemEncodedRSAKey).then(function (importedRSAKey) {
                        return encryptMessageUsingRSA(importedRSAKey, rawAESKey).then(function (encryptedAESKey) {
                            // console.log("IV:",cryptoWorkResults.iv,JSON.stringify(cryptoWorkResults.iv));
                            // console.log("IV as str:",ab2str(cryptoWorkResults.iv));
                            // let str = ab2str(cryptoWorkResults.iv)
                            // let txt = new TextDecoder("utf-8").decode(cryptoWorkResults.iv)
                            // console.log("@@@@@@",txt);
                            // console.log(new TextEncoder("utf-8").encode(txt));


                            let finalObject = {
                                encryptedAesKey: ab2str(encryptedAESKey),
                                iv: cryptoWorkResults.iv,
                                ciphertext: cryptoWorkResults.ciphertext
                            }

                            return finalObject;
                        });
                    });
                });

            });

            console.log("FinalObject");
            finalObjectToSubmit.then(function (finalObject) {
                console.log(finalObject);

                firebase.database().ref('/users/' + 'XAepUq8eXNOBwhlh7gOsckXgPNn2' + '/forms/' + KEY_NAME).set({
                    ciphertext: finalObject.ciphertext,
                    iv: finalObject.iv,
                    encryptedAesKey: finalObject.encryptedAesKey
                });

            })
            //TODO: vrem formularul criptat, cheia AES criptata folosind cheia RSA si 
            //vectorul de initializare criptat tot cu cheia RSA
        })
        
    </script>


</body>

</html>